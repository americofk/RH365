{"version":3,"file":"tax-details.js","sourceRoot":"","sources":["../../../TS/Taxes/tax-details.ts"],"names":[],"mappings":"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","sourcesContent":["// ============================================================================\n// Archivo: tax-details.ts\n// Proyecto: RH365.WebMVC\n// Ruta: TS/Taxes/tax-details.ts\n// Descripción: \n//   - Gestión completa de TaxDetails (Detalles de Impuesto)\n//   - CRUD independiente: Crear, Leer, Actualizar, Eliminar\n//   - Renderizado de tabla de detalles\n//   - Modal para agregar/editar detalles\n//   - Filtrado por TaxRefRecID\n// Estándar: ISO 27001 - Gestión de datos relacionados\n// ============================================================================\n\n(function () {\n    const w: any = window;\n    const d: Document = document;\n    const $: any = w.jQuery || w.$;\n\n    const apiBase: string = w.RH365.urls.apiBase;\n\n    // Variables globales del módulo\n    let taxDetails: any[] = [];\n    let editingDetailId: number | null = null;\n    let currentTaxRecID: number = 0;\n    let authToken: string = \"\";\n\n    // ========================================================================\n    // UTILIDADES\n    // ========================================================================\n\n    /**\n     * Realiza una petición HTTP al API\n     */\n    const fetchJson = async (url: string, options?: RequestInit): Promise<any> => {\n        const headers: Record<string, string> = {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        };\n\n        if (authToken) {\n            headers['Authorization'] = `Bearer ${authToken}`;\n        }\n\n        const response = await fetch(url, { ...options, headers });\n\n        if (!response.ok) {\n            const errorData = await response.json().catch(() => ({}));\n            throw new Error(JSON.stringify(errorData));\n        }\n\n        return response.json();\n    };\n\n    /**\n     * Formatea números con separadores de miles\n     */\n    const formatNumber = (value: number): string => {\n        return value.toLocaleString('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n    };\n\n    // ========================================================================\n    // CARGA Y RENDERIZADO DE DATOS\n    // ========================================================================\n\n    /**\n     * Carga los detalles de impuesto desde el API\n     */\n    const loadTaxDetails = async (): Promise<void> => {\n        try {\n            const url = `${apiBase}/TaxDetails?skip=0&take=1000`;\n            const response = await fetchJson(url);\n            \n            // Manejar diferentes formatos de respuesta\n            let allDetails: any[] = [];\n            if (Array.isArray(response)) {\n                allDetails = response;\n            } else if (response?.Data && Array.isArray(response.Data)) {\n                allDetails = response.Data;\n            } else if (response?.data && Array.isArray(response.data)) {\n                allDetails = response.data;\n            }\n\n            // Filtrar por TaxRefRecID\n            taxDetails = allDetails.filter((detail: any) => detail.TaxRefRecID === currentTaxRecID);\n            \n            renderTaxDetailsTable();\n        } catch (error) {\n            console.error('Error cargando detalles de impuesto:', error);\n            taxDetails = [];\n            renderTaxDetailsTable();\n        }\n    };\n\n    /**\n     * Renderiza la tabla de detalles de impuesto\n     */\n    const renderTaxDetailsTable = (): void => {\n        const container = $('#tax-details-table-body');\n        container.empty();\n\n        if (taxDetails.length === 0) {\n            container.html(`\n                <tr>\n                    <td colspan=\"8\" class=\"text-center text-muted\">\n                        <i class=\"fa fa-info-circle\"></i> No hay detalles registrados\n                    </td>\n                </tr>\n            `);\n            return;\n        }\n\n        taxDetails.forEach((detail: any) => {\n            const row = `\n                <tr data-recid=\"${detail.RecID}\">\n                    <td class=\"text-center\">${detail.ID || ''}</td>\n                    <td class=\"text-right\">${formatNumber(detail.AnnualAmountHigher || 0)}</td>\n                    <td class=\"text-right\">${formatNumber(detail.AnnualAmountNotExceed || 0)}</td>\n                    <td class=\"text-right\">${formatNumber(detail.Percent || 0)}%</td>\n                    <td class=\"text-right\">${formatNumber(detail.FixedAmount || 0)}</td>\n                    <td class=\"text-right\">${formatNumber(detail.ApplicableScale || 0)}</td>\n                    <td>${detail.Observations || ''}</td>\n                    <td class=\"text-center\">\n                        <button type=\"button\" class=\"btn btn-xs btn-warning btn-edit-detail\" data-recid=\"${detail.RecID}\">\n                            <i class=\"fa fa-pencil\"></i>\n                        </button>\n                        <button type=\"button\" class=\"btn btn-xs btn-danger btn-delete-detail\" data-recid=\"${detail.RecID}\">\n                            <i class=\"fa fa-trash\"></i>\n                        </button>\n                    </td>\n                </tr>\n            `;\n            container.append(row);\n        });\n\n        // Agregar event listeners\n        $('.btn-edit-detail').off('click').on('click', function() {\n            const detailRecId = parseInt($(this).data('recid'), 10);\n            editTaxDetail(detailRecId);\n        });\n\n        $('.btn-delete-detail').off('click').on('click', function() {\n            const detailRecId = parseInt($(this).data('recid'), 10);\n            deleteTaxDetail(detailRecId);\n        });\n    };\n\n    // ========================================================================\n    // OPERACIONES CRUD\n    // ========================================================================\n\n    /**\n     * Abre el modal para crear un nuevo detalle\n     */\n    const openNewDetailModal = (): void => {\n        editingDetailId = null;\n        \n        // Limpiar formulario\n        $('#detail-AnnualAmountHigher').val('0');\n        $('#detail-AnnualAmountNotExceed').val('0');\n        $('#detail-Percent').val('0');\n        $('#detail-FixedAmount').val('0');\n        $('#detail-ApplicableScale').val('0');\n        $('#detail-Observations').val('');\n\n        $('#modal-detail-title').text('Nuevo Detalle');\n        ($ as any)('#modal-tax-detail').modal('show');\n    };\n\n    /**\n     * Edita un detalle existente\n     */\n    const editTaxDetail = (detailRecId: number): void => {\n        const detail = taxDetails.find(d => d.RecID === detailRecId);\n        if (!detail) return;\n\n        editingDetailId = detailRecId;\n\n        // Cargar datos en el formulario\n        $('#detail-AnnualAmountHigher').val(detail.AnnualAmountHigher || 0);\n        $('#detail-AnnualAmountNotExceed').val(detail.AnnualAmountNotExceed || 0);\n        $('#detail-Percent').val(detail.Percent || 0);\n        $('#detail-FixedAmount').val(detail.FixedAmount || 0);\n        $('#detail-ApplicableScale').val(detail.ApplicableScale || 0);\n        $('#detail-Observations').val(detail.Observations || '');\n\n        $('#modal-detail-title').text('Editar Detalle');\n        ($ as any)('#modal-tax-detail').modal('show');\n    };\n\n    /**\n     * Guarda un detalle (crear o actualizar)\n     */\n    const saveTaxDetail = async (): Promise<void> => {\n        const formData = {\n            TaxRefRecID: currentTaxRecID,\n            AnnualAmountHigher: parseFloat($('#detail-AnnualAmountHigher').val() as string) || 0,\n            AnnualAmountNotExceed: parseFloat($('#detail-AnnualAmountNotExceed').val() as string) || 0,\n            Percent: parseFloat($('#detail-Percent').val() as string) || 0,\n            FixedAmount: parseFloat($('#detail-FixedAmount').val() as string) || 0,\n            ApplicableScale: parseFloat($('#detail-ApplicableScale').val() as string) || 0,\n            Observations: $('#detail-Observations').val() as string || null\n        };\n\n        try {\n            if (editingDetailId) {\n                // Actualizar\n                const url = `${apiBase}/TaxDetails/${editingDetailId}`;\n                await fetchJson(url, {\n                    method: 'PUT',\n                    body: JSON.stringify(formData)\n                });\n                (w as any).ALERTS.ok('Detalle actualizado exitosamente', 'Éxito');\n            } else {\n                // Crear\n                const url = `${apiBase}/TaxDetails`;\n                await fetchJson(url, {\n                    method: 'POST',\n                    body: JSON.stringify(formData)\n                });\n                (w as any).ALERTS.ok('Detalle creado exitosamente', 'Éxito');\n            }\n\n            ($ as any)('#modal-tax-detail').modal('hide');\n            await loadTaxDetails();\n        } catch (error: any) {\n            console.error('Error al guardar detalle:', error);\n            \n            let errorMessage = 'Error al guardar el detalle';\n            try {\n                const errorData = JSON.parse(error.message);\n                if (errorData.errors) {\n                    const errorsArray: string[] = [];\n                    for (const key in errorData.errors) {\n                        if (errorData.errors.hasOwnProperty(key)) {\n                            const errList = errorData.errors[key];\n                            if (Array.isArray(errList)) {\n                                errorsArray.push(...errList);\n                            } else {\n                                errorsArray.push(errList);\n                            }\n                        }\n                    }\n                    errorMessage = errorsArray.join(', ');\n                } else if (errorData.title) {\n                    errorMessage = errorData.title;\n                }\n            } catch {\n                errorMessage = error.message || errorMessage;\n            }\n            \n            (w as any).ALERTS.error(errorMessage, 'Error');\n        }\n    };\n\n    /**\n     * Elimina un detalle\n     */\n    const deleteTaxDetail = async (detailRecId: number): Promise<void> => {\n        (w as any).ALERTS.confirm(\n            '¿Está seguro de eliminar este detalle?',\n            'Confirmar Eliminación',\n            async (confirmed: boolean) => {\n                if (!confirmed) return;\n\n                try {\n                    const url = `${apiBase}/TaxDetails/${detailRecId}`;\n                    await fetchJson(url, { method: 'DELETE' });\n                    \n                    (w as any).ALERTS.ok('Detalle eliminado exitosamente', 'Éxito');\n                    await loadTaxDetails();\n                } catch (error) {\n                    console.error('Error al eliminar detalle:', error);\n                    (w as any).ALERTS.error('Error al eliminar el detalle', 'Error');\n                }\n            },\n            { type: 'danger' }\n        );\n    };\n\n    // ========================================================================\n    // EVENT HANDLERS\n    // ========================================================================\n\n    /**\n     * Manejador del botón Nuevo Detalle\n     */\n    $('#btn-new-detail').on('click', () => {\n        openNewDetailModal();\n    });\n\n    /**\n     * Manejador del botón Guardar Detalle en el modal\n     */\n    $('#btn-save-detail').on('click', async () => {\n        await saveTaxDetail();\n    });\n\n    // ========================================================================\n    // API PÚBLICA DEL MÓDULO\n    // ========================================================================\n\n    /**\n     * Inicializa el módulo de TaxDetails\n     * @param taxRecID RecID del impuesto padre\n     * @param token Token de autenticación\n     */\n    const initialize = async (taxRecID: number, token: string): Promise<void> => {\n        currentTaxRecID = taxRecID;\n        authToken = token;\n\n        if (taxRecID && taxRecID > 0) {\n            await loadTaxDetails();\n        } else {\n            // Modo creación - mostrar mensaje\n            $('#tax-details-table-body').html(`\n                <tr>\n                    <td colspan=\"8\" class=\"text-center text-warning\">\n                        <i class=\"fa fa-info-circle\"></i>\n                        <strong>Modo Creación:</strong> \n                        Debe guardar el impuesto primero antes de agregar detalles.\n                    </td>\n                </tr>\n            `);\n            \n            // Deshabilitar botón de nuevo detalle\n            $('#btn-new-detail').prop('disabled', true);\n        }\n    };\n\n    /**\n     * Recarga los detalles desde el API\n     */\n    const refresh = async (): Promise<void> => {\n        if (currentTaxRecID && currentTaxRecID > 0) {\n            await loadTaxDetails();\n        }\n    };\n\n    // Exportar funciones públicas al objeto global\n    (w as any).TaxDetailsModule = {\n        initialize,\n        refresh\n    };\n\n})();\n"]}