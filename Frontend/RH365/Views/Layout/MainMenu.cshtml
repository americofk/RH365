@* ============================================================================
   Archivo: _MainMenu.cshtml
   Proyecto: RH365.WebMVC
   Ruta: Views/Layout/_MainMenu.cshtml
   Descripción: Menú lateral dinámico desde sesión (sin contenido estático)
   ============================================================================ *@
@using RH365.Core.Domain.Models.Menu
@using System.Text.Json

@{
    var menusJson = Context.Session.GetString("UserMenus");
    List<MenuItemResponse>? menus = null;

    if (!string.IsNullOrEmpty(menusJson))
    {
        menus = JsonSerializer.Deserialize<List<MenuItemResponse>>(
            menusJson,
            new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
        );
    }

    // Normalizar listas
    menus ??= new List<MenuItemResponse>();
    var generalMenus = menus.Where(m => m.Sort <= 5).OrderBy(m => m.Sort).ToList();
    var configMenus = menus.Where(m => m.Sort > 5).OrderBy(m => m.Sort).ToList();
}

<!-- sidebar menu -->
<div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
    @if (menus.Any())
    {
        @* ===================== GENERAL ===================== *@
        @if (generalMenus.Any())
        {
            <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                    @foreach (var menu in generalMenus)
                    {
                        var hasChildren = menu.HasChildren && menu.Children != null && menu.Children.Any();
                        <li>
                            @if (hasChildren)
                            {
                                <a><i class="@menu.Icon"></i> @menu.MenuName <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    @foreach (var child in menu.Children!.OrderBy(c => c.Sort))
                                    {
                                        if (!string.IsNullOrWhiteSpace(child.Action) && child.Action != "#")
                                        {
                                            var action = child.Action.Trim();
                                            if (action.StartsWith("/"))
                                            {
                                                <li><a href="@Url.Content(action)">@child.MenuName</a></li>
                                            }
                                            else
                                            {
                                                var parts = action.Split('/');
                                                if (parts.Length == 2)
                                                {
                                                    <li><a href="@Url.Action(parts[1], parts[0])">@child.MenuName</a></li>
                                                }
                                                else
                                                {
                                                    <li><a href="@Url.Action(action, "Home")">@child.MenuName</a></li>
                                                }
                                            }
                                        }
                                        else
                                        {
                                            <li><a href="#">@child.MenuName</a></li>
                                        }
                                    }
                                </ul>
                            }
                            else
                            {
                                if (!string.IsNullOrWhiteSpace(menu.Action) && menu.Action != "#")
                                {
                                    var action = menu.Action.Trim();
                                    if (action.StartsWith("/"))
                                    {
                                        <a href="@Url.Content(action)"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                    }
                                    else
                                    {
                                        var parts = action.Split('/');
                                        if (parts.Length == 2)
                                        {
                                            <a href="@Url.Action(parts[1], parts[0])"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action(action, "Home")"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                        }
                                    }
                                }
                                else
                                {
                                    <a href="#"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                }
                            }
                        </li>
                    }
                </ul>
            </div>
        }

        @* ===================== CONFIGURACIÓN ===================== *@
        @if (configMenus.Any())
        {
            <div class="menu_section">
                <h3>Master Data / Configuration</h3>
                <ul class="nav side-menu">
                    @foreach (var menu in configMenus)
                    {
                        var hasChildren = menu.HasChildren && menu.Children != null && menu.Children.Any();
                        <li>
                            @if (hasChildren)
                            {
                                <a><i class="@menu.Icon"></i> @menu.MenuName <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    @foreach (var child in menu.Children!.OrderBy(c => c.Sort))
                                    {
                                        if (!string.IsNullOrWhiteSpace(child.Action) && child.Action != "#")
                                        {
                                            var action = child.Action.Trim();
                                            if (action.StartsWith("/"))
                                            {
                                                <li><a href="@Url.Content(action)">@child.MenuName</a></li>
                                            }
                                            else
                                            {
                                                var parts = action.Split('/');
                                                if (parts.Length == 2)
                                                {
                                                    <li><a href="@Url.Action(parts[1], parts[0])">@child.MenuName</a></li>
                                                }
                                                else
                                                {
                                                    <li><a href="@Url.Action(action, "Home")">@child.MenuName</a></li>
                                                }
                                            }
                                        }
                                        else
                                        {
                                            <li><a href="#">@child.MenuName</a></li>
                                        }
                                    }
                                </ul>
                            }
                            else
                            {
                                if (!string.IsNullOrWhiteSpace(menu.Action) && menu.Action != "#")
                                {
                                    var action = menu.Action.Trim();
                                    if (action.StartsWith("/"))
                                    {
                                        <a href="@Url.Content(action)"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action(action, "Home")"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                    }
                                }
                                else
                                {
                                    <a href="#"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                }
                            }
                        </li>
                    }
                </ul>
            </div>
        }
    }
    @* Si no hay menús en sesión, no se muestra nada (sin estático) *@
</div>
<!-- /sidebar menu -->
