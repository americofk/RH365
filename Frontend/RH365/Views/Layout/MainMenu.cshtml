@* ============================================================================
   Archivo: _MainMenu.cshtml
   Proyecto: RH365.WebMVC
   Ruta: RH365/Views/Layout/_MainMenu.cshtml
   Descripción:
     - Vista parcial para menú lateral dinámico
     - Lee menús desde sesión cargados en login
   ============================================================================ *@
@using RH365.Core.Domain.Models.Menu
@using System.Text.Json
@{
    var menusJson = Context.Session.GetString("UserMenus");
    List<MenuItemResponse>? menus = null;

    if (!string.IsNullOrEmpty(menusJson))
    {
        menus = JsonSerializer.Deserialize<List<MenuItemResponse>>(menusJson);
    }
}

<!-- sidebar menu -->
<div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
    @if (menus != null && menus.Any())
    {
        // Separar menús por sección
        var generalMenus = menus.Where(m => m.Sort <= 5).OrderBy(m => m.Sort).ToList();
        var configMenus = menus.Where(m => m.Sort > 5).OrderBy(m => m.Sort).ToList();

        @if (generalMenus.Any())
        {
            <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                    @foreach (var menu in generalMenus)
                    {
                        <li>
                            @if (menu.HasChildren)
                            {
                                <a><i class="@menu.Icon"></i> @menu.MenuName <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    @foreach (var child in menu.Children.OrderBy(c => c.Sort))
                                    {
                                        @if (!string.IsNullOrEmpty(child.Action) && child.Action != "#")
                                        {
                                            var parts = child.Action.Split('/');
                                            if (parts.Length == 2)
                                            {
                                                <li><a href="@Url.Action(parts[1], parts[0])">@child.MenuName</a></li>
                                            }
                                            else
                                            {
                                                <li><a href="@Url.Action(child.Action, "Home")">@child.MenuName</a></li>
                                            }
                                        }
                                        else
                                        {
                                            <li><a href="#">@child.MenuName</a></li>
                                        }
                                    }
                                </ul>
                            }
                            else
                            {
                                @if (menu.Action == "Index" && menu.MenuCode == "MENU-HOME")
                                {
                                    <a href="@Url.Action("Index", "Home")"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                }
                                else if (!string.IsNullOrEmpty(menu.Action) && menu.Action != "#")
                                {
                                    var parts = menu.Action.Split('/');
                                    if (parts.Length == 2)
                                    {
                                        <a href="@Url.Action(parts[1], parts[0])"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action(menu.Action, "Home")"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                    }
                                }
                                else
                                {
                                    <a href="#"><i class="@menu.Icon"></i> @menu.MenuName</a>
                                }
                            }
                        </li>
                    }
                </ul>
            </div>
        }

        @if (configMenus.Any())
        {
            <div class="menu_section">
                <h3>Master Data / Configuration</h3>
                <ul class="nav side-menu">
                    @foreach (var menu in configMenus)
                    {
                        <li>
                            @if (menu.HasChildren)
                            {
                                <a><i class="@menu.Icon"></i> @menu.MenuName <span class="fa fa-chevron-down"></span></a>
                                <ul class="nav child_menu">
                                    @foreach (var child in menu.Children.OrderBy(c => c.Sort))
                                    {
                                        @if (!string.IsNullOrEmpty(child.Action) && child.Action != "#")
                                        {
                                            <li><a href="@Url.Action(child.Action, "Home")">@child.MenuName</a></li>
                                        }
                                        else
                                        {
                                            <li><a href="#">@child.MenuName</a></li>
                                        }
                                    }
                                </ul>
                            }
                            else
                            {
                                <a href="#"><i class="@menu.Icon"></i> @menu.MenuName</a>
                            }
                        </li>
                    }
                </ul>
            </div>
        }
    }
    else
    {
        // Menú estático de respaldo si no hay menús en sesión
        <div class="menu_section">
            <h3>General</h3>
            <ul class="nav side-menu">
                <li><a href="@Url.Action("Index", "Home")"><i class="fa fa-home"></i> Home</a></li>
            </ul>
        </div>
    }
</div>
<!-- /sidebar menu -->